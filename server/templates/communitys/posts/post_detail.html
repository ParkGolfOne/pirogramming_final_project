{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>파골원 커뮤 디테일</title>
    <link rel="stylesheet" href="{%static 'posts/css/post_detail.css'%}" />
  </head>
  <body>
    <a href="{% url 'communitys:board_list' %}">커뮤니티 홈</a>
    <a href="{% url 'communitys:post_list' bid %}">게시판 홈</a>
    <div>
      {% if user.is_authenticated %}
      <a href="{% url 'users:logout'%}">로그아웃</a>{% else %}
      <a href="{% url 'users:login'%}"> 로그인</a
      ><a href="{% url 'users:signup'%}"> 회원가입</a>{% endif %}
    </div>
    <div>
      <h1 style="color: green; font-size: 40px">{{post.title}}</h1>
      <h3>{{post.writer}}</h3>
      {% if post.photo.url != '' %}
      <img src="{{post.photo.url}}" alt="게시글 이미지" />
      {% else %}
      <img src="{% static 'posts/images/no_images.png' %}" alt="대체 텍스트" />
      {% endif %}

      <div>[공유하기 넣을 곳]</div>

      <h2 class="my-3">{{post.content}}</h2>
      <p>작성일: {{post.created_date}}</p>
      <p>수정일: {{post.updated_date}}</p>

      <hr />
      <div class="post_buttons">
        <div class="likeNum-{{post.id}}">좋아요 {{post.like_num}}</div>
        <div class="scrapNum-{{post.id}}">스크랩 {{post.scrap_num}}</div>
        {% if user.is_authenticated %} {%if liked%}
        <button
          class="postLikeBtn like-{{post.id}} liked"
          onclick="pushLike({{post.id}})"
        ></button>
        {%else%}
        <button
          class="postLikeBtn like-{{post.id}}"
          onclick="pushLike({{post.id}})"
        ></button>
        {% endif %} {%if scraped%}
        <button
          class="postScrapBtn scrap-{{post.id}} scraped"
          onclick="pushScrap({{post.id}})"
        ></button>
        {%else%}
        <button
          class="postScrapBtn scrap-{{post.id}}"
          onclick="pushScrap({{post.id}})"
        ></button>
        {% endif %} {% endif %}
      </div>
      {% if post.writer == now_user %}
      <form
        action="{% url 'communitys:post_delete' bid post.pk %}"
        method="POST"
      >
        {%csrf_token%}
        <a
          href="{% url 'communitys:post_update' bid post.pk %}"
          class="btn btn-primary"
          >수정하기</a
        >
        <button type="submit">삭제하기</button>
      </form>
      {% endif %}
      <hr />
      <h3>댓글</h3>
      <div class="commentSection">
        {% if comments %} {% for comment in comments%}
        <div class="a_comment Cid-{{comment.id}}">
          <div class="a_comment_commenter">{{comment.commenter.username}}</div>
          <div class="a_comment_content">{{comment.content}}</div>
          {% if comment.commenter == now_user%}
          <button
            class="a_comment_delete"
            onclick="deleteComment({{comment.id}})"
          >
            삭제
          </button>
          <button
            class="a_comment_delete"
            onclick="updateCommentBtn({{comment.id}})"
          >
            수정
          </button>
          {% endif %} {% if user.is_authenticated %}
          <button
            class="a_comment_delete"
            onclick="likeComment({{comment.id}})"
          >
            좋아요
          </button>
          <button
            class="a_comment_reply"
            onclick="writeReply({{post.id}}, {{comment.id}})"
          >
            답글
          </button>
          {% endif %} {% if comment.child_comments_num > 0 %}
          <div>
            <button
              class="a_comment_reply"
              onclick="openReply({{post.id}}, {{comment.id}})"
            >
              답글 {{comment.child_comments_num}} 개
            </button>
          </div>
          {% endif %}
          <section class="replySection"></section>
        </div>

        {%endfor%} {% endif%}
      </div>

      <hr />
      {% if user.is_authenticated %}
      <div class="input-area">
        <input type="text" class="comment-input-box" /><button
          class="comment-upload-btn"
          onclick="writeComment({{post.id}})"
        >
          등록
        </button>
      </div>
      {%else%}
      <div class="input-area">
        <span> 댓글을 작성하려면 로그인을 해주세요!</span>
      </div>
      {% endif%}
      <hr />
    </div>

    <!-- 댓글 -->
    <script>
      // 댓글 제거 부분

      const requestCommentDelete = new XMLHttpRequest();

      // 함수명 : deleteComment
      // 전달인자 : post_id
      // 기능 : 서버에 댓글 삭제 요청 및, 해당 post_id 전달
      function deleteComment(comment_id) {
        const url = `/communitys/comment_delete/${comment_id}/`;
        requestCommentDelete.open("POST", url, true);
        requestCommentDelete.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded"
        );
        requestCommentDelete.send(JSON.stringify({ comment_id: comment_id }));
      }

      // 댓글 삭제 요청 응답 온 후
      requestCommentDelete.onreadystatechange = () => {
        if (requestCommentDelete.readyState === XMLHttpRequest.DONE) {
          if (requestCommentDelete.status < 400) {
            const { comment_id } = JSON.parse(requestCommentDelete.response);
            const element = document.querySelector(`.Cid-${comment_id}`);
            element.remove();
          }
        }
      };

      // 댓글 추가 부분

      //새 HTTPRequest 생성
      const requestCommentAdd = new XMLHttpRequest();

      // 함수명 : writeComment
      // 전달인자 : post_id
      // 기능 : 서버에 댓글 작성 요청 및 댓글 내용 전달
      function writeComment(post_id) {
        const content = document.querySelector(".comment-input-box");

        const url = `/communitys/comment_create/`;
        requestCommentAdd.open("POST", url, true);
        requestCommentAdd.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded"
        );
        requestCommentAdd.send(
          JSON.stringify({
            post_id: post_id,
            content: content.value,
          })
        );
        content.value = "";
      }

      // 댓글 추가 요청 응답 온 후
      requestCommentAdd.onreadystatechange = () => {
        if (requestCommentAdd.readyState === XMLHttpRequest.DONE) {
          if (requestCommentAdd.status < 400) {
            const { commenter, content, commentId, post_id } = JSON.parse(
              requestCommentAdd.response
            );
            const element = document.querySelector(".commentSection");
            let originHTML = element.innerHTML;
            element.innerHTML += `<div class="a_comment Cid-${commentId}">
            <div class="a_comment_commenter">${commenter}</div>
            <div class="a_comment_content">${content}</div>
            <button
              class="a_comment_delete"
              onclick="deleteComment(${commentId})"
            >
              삭제
            </button>
            <button
              class="a_comment_delete"
              onclick="updateCommentBtn(${commentId})"
            >
              수정
            </button>
            <button
              class="a_comment_delete"
              onclick="likeComment(${commentId})"
            >
              좋아요
            </button>
            <button
              class="a_comment_reply"
              onclick="writeReply(${post_id}, ${commentId})"
            >
              답글
            </button>
            </div><section class="replySection"></section>`;
          }
        }
      };

      // 댓글 업데이트 부분
      //새 HTTPRequest 생성
      const requestCommentUpdate = new XMLHttpRequest();

      // 함수명 : updateComment
      // 전달인자 : comment_id
      // 기능 : 서버에 댓글 작성 요청 및 댓글 내용 전달
      function updateComment(comment_id) {
        const content = document.querySelector(".comment-update-box");

        const url = `/communitys/comment_update/${comment_id}/`;
        requestCommentUpdate.open("POST", url, true);
        requestCommentUpdate.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded"
        );
        requestCommentUpdate.send(
          JSON.stringify({
            comment_id: comment_id,
            content: content.value,
          })
        );
        content.value = "";
      }

      // 댓글 업데이트 요청 응답 온 후
      requestCommentUpdate.onreadystatechange = () => {
        if (requestCommentUpdate.readyState === XMLHttpRequest.DONE) {
          if (requestCommentUpdate.status < 400) {
            const { commenter, content, commentId, post_id } = JSON.parse(
              requestCommentUpdate.response
            );
            const element = document.querySelector(`.Cid-${commentId}`);
            element.innerHTML = `<div class="a_comment_commenter">${commenter}</div>
            <div class="a_comment_content">${content}</div>
            <button
              class="a_comment_delete"
              onclick="deleteComment(${commentId})"
            >
              삭제
            </button>
            <button
              class="a_comment_delete"
              onclick="updateCommentBtn(${commentId})"
            >
              수정
            </button>
            <button
              class="a_comment_delete"
              onclick="likeComment(${commentId})"
            >
              좋아요
            </button>
            <button
              class="a_comment_reply"
              onclick="writeReply(${post_id}, ${commentId})"
            >
              답글
            </button><section class="replySection"></section>`;
          }
        }
      };

      // 함수명 : updateCommentBtn
      // 전달인자 : comment_id
      // 기능 : 댓글 업데이트 버튼 입력시 input 칸으로 변경
      function updateCommentBtn(comment_id) {
        const element = document.querySelector(`.Cid-${comment_id}`);
        element.innerHTML = `<div class="input-area">
        <input type="text" class="comment-update-box" /><button
          class="comment-upload-btn"
          onclick="updateComment(${comment_id})"
        >
          수정
        </button>
      </div>`;
      }
    </script>

    <!-- 대댓글  -->
    <script>
      // 대댓글 열람 부분

      //새 HTTPRequest 생성
      const requestReplyOpen = new XMLHttpRequest();

      // 함수명 : writeReply
      // 전달인자 : post_id
      // 기능 : 서버에 댓글 작성 요청 및 댓글 내용 전달
      function openReply(post_id, parent_comment_id) {
        const url = `/communitys/comment_create/`;
        requestReplyOpen.open("POST", url, true);
        requestReplyOpen.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded"
        );
        requestReplyOpen.send(
          JSON.stringify({
            post_id: post_id,
            parent_comment_id: parent_comment_id,
          })
        );
      }

      // 대댓글 열람 요청 응답 온 후
      requestReplyOpen.onreadystatechange = () => {
        if (requestReplyOpen.readyState === XMLHttpRequest.DONE) {
          if (requestReplyOpen.status < 400) {
            const { commenter, content, commentId, post_id } = JSON.parse(
              requestReplyOpen.response
            );

            const element = document.querySelector(".commentSection");
            let originHTML = element.innerHTML;
            element.innerHTML += `<div class="a_comment Cid-${commentId}">
            <div class="a_comment_commenter">${commenter}</div>
            <div class="a_comment_content">${content}</div>
            <button
              class="a_comment_delete"
              onclick="deleteComment(${commentId})"
            >
              삭제
            </button>
            <button
              class="a_comment_delete"
              onclick="updateCommentBtn(${commentId})"
            >
              수정
            </button>
            <button
              class="a_comment_delete"
              onclick="likeComment(${commentId})"
            >
              좋아요
            </button>
            <button
              class="a_comment_reply"
              onclick="replyComment(${post_id}, ${commentId})"
            >`;
          }
        }
      };

      // 대댓글 탭 닫기
      function closeReply(post_id, parent_comment_id) {
        const content = document.querySelector(".comment-input-box");
      }

      // 대댓글 추가 부분

      //새 HTTPRequest 생성
      const requestReplyAdd = new XMLHttpRequest();

      // 함수명 : writeReply
      // 전달인자 : post_id
      // 기능 : 서버에 댓글 작성 요청 및 댓글 내용 전달
      function writeReply(post_id, parent_comment_id) {
        const content = document.querySelector(".comment-input-box");

        const url = `/communitys/comment_create/`;
        requestReplyAdd.open("POST", url, true);
        requestReplyAdd.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded"
        );
        requestReplyAdd.send(
          JSON.stringify({
            post_id: post_id,
            content: content.value,
            parent_comment_id: parent_comment_id,
          })
        );
        content.value = "";
      }

      // 대댓글 추가 요청 응답 온 후
      requestReplyAdd.onreadystatechange = () => {
        if (requestReplyAdd.readyState === XMLHttpRequest.DONE) {
          if (requestReplyAdd.status < 400) {
            const { commenter, content, commentId, post_id } = JSON.parse(
              requestReplyAdd.response
            );
            const element = document.querySelector(".commentSection");
            let originHTML = element.innerHTML;
            element.innerHTML += `<div class="a_comment Cid-${commentId}">
            <div class="a_comment_commenter">${commenter}</div>
            <div class="a_comment_content">${content}</div>
            <button
              class="a_comment_delete"
              onclick="deleteComment(${commentId})"
            >
              삭제
            </button>
            <button
              class="a_comment_delete"
              onclick="updateCommentBtn(${commentId})"
            >
              수정
            </button>
            <button
              class="a_comment_delete"
              onclick="likeComment(${commentId})"
            >
              좋아요
            </button>`;
          }
        }
      };
    </script>

    <script>
      //좋아요 함수 부분
      const requestLike = new XMLHttpRequest();
      function pushLike(post_id) {
        const likebutton = document.querySelector(`.like-${post_id}`);
        likebutton.classList.toggle("liked");
        const url = "/communitys/post_like/";
        requestLike.open("POST", url, true);
        requestLike.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded"
        );

        requestLike.send(JSON.stringify({ post_id: post_id }));
      }

      requestLike.onreadystatechange = () => {
        if (requestLike.readyState === XMLHttpRequest.DONE) {
          if (requestLike.status < 400) {
            const { post_id, LikeNum, likeTag } = JSON.parse(
              requestLike.response
            );
            const element = document.querySelector(`.likeNum-${post_id}`);
            const originHTML = element.innerHTML;
            const [text, likenum] = originHTML.split(" ");
            let newnum = 0;

            if (likeTag == "liked") {
              newnum = Number(likenum) + 1;
            } else {
              newnum = Number(likenum) - 1;
            }

            element.innerHTML = `좋아요 ${newnum}`;
          }
        }
      };

      //스크랩 함수 부분
      const requestScrap = new XMLHttpRequest();
      function pushScrap(post_id) {
        const scrapbutton = document.querySelector(`.scrap-${post_id}`);
        scrapbutton.classList.toggle("scraped");
        const url = "/communitys/post_scrap/";
        requestScrap.open("POST", url, true);
        requestScrap.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded"
        );

        requestScrap.send(JSON.stringify({ post_id: post_id }));
      }

      requestScrap.onreadystatechange = () => {
        if (requestScrap.readyState === XMLHttpRequest.DONE) {
          if (requestScrap.status < 400) {
            const { post_id, ScrapNum, scrapTag } = JSON.parse(
              requestScrap.response
            );
            const element = document.querySelector(`.scrapNum-${post_id}`);
            const originHTML = element.innerHTML;
            const [text, scrapnum] = originHTML.split(" ");
            let newnum = 0;

            if (scrapTag == "scraped") {
              newnum = Number(scrapnum) + 1;
            } else {
              newnum = Number(scrapnum) - 1;
            }

            element.innerHTML = `스크랩 ${newnum}`;
          }
        }
      };

      //댓글 좋아요 함수 부분
      // const requestLike = new XMLHttpRequest();
      // function pushLike(post_id) {
      //   const likebutton = document.querySelector(`.like-${post_id}`);
      //   likebutton.classList.toggle("liked");
      //   const url = "/communitys/post_like/";
      //   requestLike.open("POST", url, true);
      //   requestLike.setRequestHeader(
      //     "Content-Type",
      //     "application/x-www-form-urlencoded"
      //   );

      //   requestLike.send(JSON.stringify({ post_id: post_id }));
      // }

      // requestLike.onreadystatechange = () => {
      //   if (requestLike.readyState === XMLHttpRequest.DONE) {
      //     if (requestLike.status < 400) {
      //       const { post_id, LikeNum, likeTag } = JSON.parse(
      //         requestLike.response
      //       );
      //       const element = document.querySelector(`.likeNum-${post_id}`);
      //       const originHTML = element.innerHTML;
      //       const [text, likenum] = originHTML.split(" ");
      //       let newnum = 0;

      //       if (likeTag == "liked") {
      //         newnum = Number(likenum) + 1;
      //       } else {
      //         newnum = Number(likenum) - 1;
      //       }

      //       element.innerHTML = `좋아요 ${newnum}`;
      //     }
      //   }
      // };
    </script>
  </body>
</html>
